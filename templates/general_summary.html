{% extends "base.html" %}

{% block content %}
<style>
    main { max-width: 95% !important; }

    /* Style for employee name links */
    tbody a {
        transition: all 0.2s ease;
        font-weight: bold;
    }

    tbody a:hover {
        color: #0860ca !important;
        text-decoration: underline !important;
    }

    tbody tr:hover {
        background-color: #f6f8fa;
    }
</style>
<div class="card" style="max-width: none; width: 100%;">
    <div class="header-line">
        <h2 class="section-title">
            ×¡×™×›×•× ×©×›×¨ ×›×œ×œ×™ - ×›×œ ×”××“×¨×™×›×™×
            <span style="font-size: 0.7em; color: #666; font-weight: normal; margin-right: 10px;">
                ({{ summary_data|length }} ××“×¨×™×›×™×)
            </span>
        </h2>
        <div class="controls">
            <form method="get" style="display: flex; gap: 10px; align-items: center;">
                <select name="month" onchange="this.form.submit()">
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ "%02d"|format(m) }}</option>
                    {% endfor %}
                </select>
                <select name="year" onchange="this.form.submit()">
                    {% for y in years %}
                    <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                </select>
            </form>
            <button onclick="window.print()" class="button" style="padding: 6px 12px;">×”×“×¤×¡ ×“×•×—</button>
            <a href="/export/excel?year={{ selected_year }}&month={{ selected_month }}" class="button" style="text-decoration: none; padding: 6px 12px; background: #28a745; color: white;">×™×™×¦×•× ××§×¡×œ</a>
            <a href="/export/gesher/preview?year={{ selected_year }}&month={{ selected_month }}" class="button" style="text-decoration: none; padding: 6px 12px; background: #007bff; color: white;">×™×™×¦×•× ×’×©×¨</a>
            <a href="/" class="button" style="text-decoration: none; padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; color: #333;">×—×–×¨×”</a>
        </div>
    </div>

    <!-- ×—×™×¤×•×© ×§×•×“×™ ××™×¨×‘ ×œ×¢××•×“×•×ª ×”××—×¨×•× ×•×ª - ×©×™××•×© ×‘-namespace ×›×™ Jinja2 ×œ× ×©×•××¨ ××©×ª× ×™× ××œ×•×œ××•×ª -->
    {% set ns = namespace(
        standby='',
        travel='',
        extras=''
    ) %}
    {% for code in payment_codes %}
        {% if code.internal_key == 'standby' %}
            {% set ns.standby = code.merav_code %}
        {% elif code.internal_key == 'travel' %}
            {% set ns.travel = code.merav_code %}
        {% elif code.internal_key == 'extras' %}
            {% set ns.extras = code.merav_code %}
        {% endif %}
    {% endfor %}
    
    <div style="overflow-x: auto; margin-top: 20px; width: 100%;">
        <table id="summaryTable" style="width: 100%; border-collapse: collapse; min-width: 1600px; table-layout: auto;">
            <thead>
                <tr style="background: #f2f4f7;">
                    <th onclick="sortTable(this.cellIndex)" style="cursor: pointer; position: sticky; right: 0; background: #f2f4f7; z-index: 2; border-left: 2px solid #ddd;">×©× ×”××“×¨×™×š â‡…</th>
                    <!-- Dynamic Columns from Payment Codes -->
                    {% for code in payment_codes %}
                    {% if code.internal_key not in ['sick_days_accrued', 'vacation_days_accrued', 'vacation_days_taken', 'travel', 'extras', 'calc150_shabbat_100', 'calc150_shabbat_50', 'sick_days_taken'] %}
                    
                    {% set display_text = code.display_name %}
                    {% if code.internal_key == 'actual_work_days' %}
                        {% set display_text = '×™××™ ×¢×‘×•×“×”' %}
                    {% elif code.internal_key == 'total_hours' %}
                        {% set display_text = '×¡×”×› ×©×¢×•×ª' %}
                    {% endif %}
                    
                    {% set icon = code.icon if 'icon' in code.keys() and code.icon else '' %}
                    {% if not icon %}
                        {# Fallback icons if not in DB #}
                        {% if code.internal_key == 'calc100' %}
                            {% set icon = 'â°' %}
                        {% elif code.internal_key == 'calc125' %}
                            {% set icon = 'â±ï¸' %}
                        {% elif code.internal_key == 'calc150_shabbat' %}
                            {% set icon = 'ğŸ•¯ï¸' %}
                        {% elif code.internal_key == 'calc150_overtime' %}
                            {% set icon = 'â±ï¸' %}
                        {% elif code.internal_key == 'calc175' %}
                            {% set icon = 'ğŸ•¯ï¸' %}
                        {% elif code.internal_key == 'calc200' %}
                            {% set icon = 'ğŸ•¯ï¸' %}
                        {% elif code.internal_key == 'standby' %}
                            {% set icon = 'ğŸ’¤' %}
                        {% elif code.internal_key == 'vacation' %}
                            {% set icon = 'ğŸ–ï¸' %}
                        {% elif code.internal_key == 'total_hours' %}
                            {% set icon = 'â°' %}
                        {% elif code.internal_key == 'actual_work_days' %}
                            {% set icon = 'ğŸ“…' %}
                        {% endif %}
                    {% endif %}

                    <th onclick="sortTable(this.cellIndex)" style="cursor: pointer;" title="{{ code.display_name }} ({{ code.merav_code }})">
                        {% if icon %}{{ icon }} {% endif %}{{ display_text }}
                        <div style="font-size: 0.8em; color: #666; font-weight: normal;">{{ code.merav_code }}</div>
                    </th>
                    {% endif %}
                    {% endfor %}
                    <!-- ×¢××•×“×•×ª ×›×•× × ×•×™×•×ª, × ×¡×™×¢×•×ª ×•×ª×•×¡×¤×•×ª -->
                    <th onclick="sortTable(this.cellIndex)" style="cursor: pointer; background: #dbeafe;" title="×›×•× × ×•×™×•×ª ({{ ns.standby }})">
                        ğŸ’¤ ×›×•× × ×•×™×•×ª (â‚ª)
                        <div style="font-size: 0.8em; color: #666; font-weight: normal;">{{ ns.standby }}</div>
                    </th>
                    <th onclick="sortTable(this.cellIndex)" style="cursor: pointer; background: #fef3c7;" title="× ×¡×™×¢×•×ª ({{ ns.travel }})">
                        ğŸš— × ×¡×™×¢×•×ª
                        <div style="font-size: 0.8em; color: #666; font-weight: normal;">{{ ns.travel }}</div>
                    </th>
                    <th onclick="sortTable(this.cellIndex)" style="cursor: pointer; background: #fce7f3;" title="×ª×•×¡×¤×•×ª ({{ ns.extras }})">
                        ğŸ’° ×ª×•×¡×¤×•×ª
                        <div style="font-size: 0.8em; color: #666; font-weight: normal;">{{ ns.extras }}</div>
                    </th>
                    <th onclick="sortTable(this.cellIndex)" style="cursor: pointer; background: #e7f5ff; font-weight: bold;">×¡×”"×› ×œ×ª×©×œ×•× â‡…</th>
                </tr>
            </thead>
            <tbody>
                {% for row in summary_data %}
                <tr>
                    <td style="position: sticky; right: 0; background: #fff; z-index: 1; border-left: 2px solid #eee; font-weight: bold;">
                        <a href="/guide/{{ row.person_id }}?year={{ selected_year }}&month={{ selected_month }}" style="text-decoration: none; color: #0969da;" title="×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×“×•×— ××¤×•×¨×˜">
                            {{ row.name }}
                        </a>
                    </td>
                    {% for code in payment_codes %}
                        {% if code.internal_key not in ['sick_days_accrued', 'vacation_days_accrued', 'vacation_days_taken', 'travel', 'extras', 'calc150_shabbat_100', 'calc150_shabbat_50', 'sick_days_taken'] %}
                        {% set key = code.internal_key %}
                        {% set val = row.totals[key] or 0 %}
                        
                        <td style="text-align: center;">
                            {% if val > 0 %}
                                {% if key == 'standby' %}
                                    {{ val }}
                                {% elif key == 'actual_work_days' %}
                                    {{ val }}
                                {% else %}
                                    <!-- For money/hours fields, showing the calculated amount/hours based on type? -->
                                    <!-- In the summary, usually we want Value (Hours/Units) OR Money? -->
                                    <!-- Let's show Value (Money in tooltip) -->
                                    <div>
                                        {% if key == 'total_hours' or 'calc' in key or key == 'vacation' %}
                                            {{ (val | float / 60) | round(2) }}
                                        {% else %}
                                            {{ "%.2f"|format(val) }}
                                        {% endif %}
                                    </div>
                                    <!-- Optional: Add money calculation logic here if needed, but simplistic for now -->
                                {% endif %}
                            {% else %}
                                <span style="color: #eee;">-</span>
                            {% endif %}
                        </td>
                        {% endif %}
                    {% endfor %}
                    <!-- ×›×•× × ×•×™×•×ª (×¡×›×•×) -->
                    <td style="text-align: center; background: #eff6ff;">
                        {% if row.totals.standby_payment and row.totals.standby_payment > 0 %}
                            {{ "%.2f"|format(row.totals.standby_payment) }}
                        {% else %}
                            <span style="color: #eee;">-</span>
                        {% endif %}
                    </td>
                    <!-- × ×¡×™×¢×•×ª -->
                    <td style="text-align: center; background: #fffbeb;">
                        {% if row.totals.travel and row.totals.travel > 0 %}
                            {{ "%.2f"|format(row.totals.travel) }}
                        {% else %}
                            <span style="color: #eee;">-</span>
                        {% endif %}
                    </td>
                    <!-- ×ª×•×¡×¤×•×ª/×”×—×–×¨×™× -->
                    <td style="text-align: center; background: #fdf2f8;">
                        {% if row.totals.extras and row.totals.extras > 0 %}
                            {{ "%.2f"|format(row.totals.extras) }}
                        {% else %}
                            <span style="color: #eee;">-</span>
                        {% endif %}
                    </td>
                    <td style="background: #e7f5ff; font-weight: bold;">
                        {{ (row.totals.total_payment or row.totals.payment or 0) | format_currency }}
                    </td>
                </tr>
                {% endfor %}
                
                <!-- Grand Totals Row -->
                <tr style="background: #333; color: #fff; font-weight: bold;">
                    <td style="position: sticky; right: 0; background: #333; z-index: 1; border-left: 2px solid #555;">×¡×”"×› ×›×œ×œ×™</td>
                    {% for code in payment_codes %}
                        {% if code.internal_key not in ['sick_days_accrued', 'vacation_days_accrued', 'vacation_days_taken', 'travel', 'extras', 'calc150_shabbat_100', 'calc150_shabbat_50', 'sick_days_taken'] %}
                        {% set key = code.internal_key %}
                        {% set sum_val = grand_totals[key] or 0 %}
                        <td style="text-align: center;">
                            {% if sum_val > 0 %}
                                {% if key == 'standby' or key == 'actual_work_days' %}
                                    {{ sum_val }}
                                {% elif key == 'total_hours' or 'calc' in key or key == 'vacation' %}
                                    {{ (sum_val | float / 60) | round(2) }}
                                {% else %}
                                    {{ "%.2f"|format(sum_val) }}
                                {% endif %}
                            {% endif %}
                        </td>
                        {% endif %}
                    {% endfor %}
                    <!-- ×›×•× × ×•×™×•×ª (×¡×›×•×) -->
                    <td style="text-align: center; background: #1e40af; color: #fff;">
                        {% if grand_totals.standby_payment and grand_totals.standby_payment > 0 %}
                            {{ "%.2f"|format(grand_totals.standby_payment) }}
                        {% endif %}
                    </td>
                    <!-- × ×¡×™×¢×•×ª -->
                    <td style="text-align: center; background: #b45309; color: #fff;">
                        {% if grand_totals.travel and grand_totals.travel > 0 %}
                            {{ "%.2f"|format(grand_totals.travel) }}
                        {% endif %}
                    </td>
                    <!-- ×ª×•×¡×¤×•×ª -->
                    <td style="text-align: center; background: #be185d; color: #fff;">
                        {% if grand_totals.extras and grand_totals.extras > 0 %}
                            {{ "%.2f"|format(grand_totals.extras) }}
                        {% endif %}
                    </td>
                    <td style="background: #444;">
                        {{ (grand_totals.payment or 0) | format_currency }}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
function sortTable(n) {
  var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
  table = document.getElementById("summaryTable");
  switching = true;
  // Set the sorting direction to ascending:
  dir = "asc";
  
  while (switching) {
    switching = false;
    // Get rows from the first tbody (ignoring the header row which is in thead)
    var body = table.tBodies[0];
    rows = body.rows;
    // Loop through all table rows except the last one (Grand Totals):
    for (i = 0; i < rows.length - 2; i++) {
      shouldSwitch = false;
      
      x = rows[i].getElementsByTagName("TD")[n];
      y = rows[i + 1].getElementsByTagName("TD")[n];
      
      var xVal = parseCellValue(x);
      var yVal = parseCellValue(y);
      
      if (dir == "asc") {
        if (xVal > yVal) {
          shouldSwitch = true;
          break;
        }
      } else if (dir == "desc") {
        if (xVal < yVal) {
          shouldSwitch = true;
          break;
        }
      }
    }
    if (shouldSwitch) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      switchcount ++;
    } else {
      if (switchcount == 0 && dir == "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
}

function parseCellValue(td) {
    var val = td.textContent || td.innerText;
    val = val.trim().replace(/[â‚ª,]/g, ""); // Remove currency and commas
    if (val === "" || val === "-") return -Infinity; // Treat empty as minimal
    
    var num = parseFloat(val);
    // If it's a valid number, return it. Otherwise return string for text sorting
    return isNaN(num) ? val.toLowerCase() : num;
}
</script>
{% endblock %}
