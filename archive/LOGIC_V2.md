# לוגיקת חישוב שעות ושכר - ניהול משמרות מקומי (גרסה 1.4.0)

מסמך זה מתאר את הלוגיקה המפורטת לחישוב שעות עבודה, שעות נוספות, כוננויות ותשלום, כפי שמיושמת באפליקציה.

## 1. הגדרות יסוד

### 1.1. יום עבודה vs יום קלנדרי
*   **יום קלנדרי:** מתחיל ב-00:00 ומסתיים ב-24:00 (חצות). החישובים הטכניים (שעות נוספות, תעריף שבת) מתבצעים על בסיס ציר זמן רציף וקלנדרי.
*   **יום עבודה (תצוגה):** בדוחות, יום עבודה מוצג כמתחיל בשעה **08:00 בבוקר** ומסתיים ב-**08:00 בבוקר למחרת**.
    *   רצפי עבודה שמתחילים בין 00:00 ל-08:00 בבוקר משויכים ויזואלית ליום **הקודם**.
    *   רצפים שחוצים את השעה 08:00 מפוצלים לשניים: החלק עד 08:00 מוצג ביום הקודם, והחלק מ-08:00 ביום הנוכחי.

### 1.2. תעריפי שעות (אחוזים)
*   **100%:** שעות עבודה רגילות (8 שעות ראשונות ביום חול).
*   **125%:** שעתיים נוספות ראשונות (שעות 9-10 ברצף).
*   **150%:**
    *   שעות נוספות מעבר ל-10 שעות ביום חול.
    *   שעות שבת (עד 8 שעות ראשונות).
*   **175%:** שעתיים נוספות ראשונות בשבת (שעות 9-10).
*   **200%:** שעות נוספות מעבר ל-10 שעות בשבת.

### 1.3. הגדרת שבת
שבת מוגדרת לצורך חישוב תעריף מיוחד:
*   **כניסה:** יום שישי משעה **16:00**.
*   **יציאה:** יום שבת (מוצ"ש) בשעה **22:00**.
*   כל דקת עבודה בטווח זה נחשבת כעבודה בשבת (מתחילה מ-150% ומעלה).

### 1.4. שכר מינימום
*   בסיס לחישוב: **34.40 ₪** לשעה.
*   התשלום מחושב כ: `(דקות_במקטע / 60) * אחוז_משרה * שכר_מינימום`.

---

## 2. לוגיקת חישוב רצפים (Chains)

המערכת מזהה "רצפי עבודה" כדי לחשב שעות נוספות.

### 2.1. מה שובר רצף?
רצף עבודה נקטע ומתאפס (המונה חוזר ל-0 שעות) במקרים הבאים:
1.  **כוננות:** דיווח על כוננות קוטע רצף עבודה.
2.  **הפסקה ארוכה:** הפסקה של יותר מ-**60 דקות** בין סיום מקטע עבודה אחד לתחילת הבא.

### 2.2. חישוב מצטבר בתוך רצף
עבור כל רצף עבודה רציף:
1.  המונה (`minutes_counter`) סופר דקות מתחילת הרצף.
2.  עבור כל דקה נבדק:
    *   האם היא בשבת? (לפי הגדרת השבת לעיל).
    *   כמה דקות צברנו עד כה?
3.  **קביעת התעריף לדקה:**
    *   **דקות 0-480 (8 שעות ראשונות):**
        *   חול: 100%
        *   שבת: 150%
    *   **דקות 481-600 (שעתיים הבאות):**
        *   חול: 125%
        *   שבת: 175%
    *   **דקות 601 ומעלה (מעבר ל-10 שעות):**
        *   חול: 150%
        *   שבת: 200%

### 2.3. פירוק לשורות בדוח
הדוח מציג את הרצפים מפורקים לשורות לפי תעריף.
למשל, משמרת של 12 שעות ביום חול תוצג כ-3 שורות:
1.  8 שעות (100%).
2.  2 שעות (125%).
3.  2 שעות (150%).

---

## 3. לוגיקת תצוגה (Post-Processing)

לאחר החישוב הטכני, הנתונים עוברים עיבוד לצורך תצוגה ידידותית בדוח:

### 3.1. הזזת לילה ליום הקודם
*   מערכת המשמרות עובדת במחזורים של 08:00 עד 08:00.
*   כל מקטע שמתחיל **לפני 08:00 בבוקר** ביום מסוים, מוזז לתצוגה תחת התאריך של **היום הקודם**.
    *   דוגמה: משמרת שמתחילה ביום שני ב-00:00 תוצג תחת יום ראשון.

### 3.2. פיצול ב-08:00
*   אם רצף עבודה חוצה את השעה 08:00 (מתחיל לפניה ומסתיים אחריה), הוא **מפוצל לשניים**:
    1.  **חלק א':** מההתחלה ועד 08:00 -> מוזז ליום הקודם.
    2.  **חלק ב':** מ-08:00 ועד הסוף -> נשאר ביום הנוכחי.
*   החישובים הכספיים ושעות העבודה מפוצלים באופן יחסי (פרופורציונלי) למשך הזמן של כל חלק.

### 3.3. איחוד רצפים חצויים
*   אם משמרת חצתה חצות (00:00) והפכה לשני מקטעים טכניים (למשל 22:00-00:00 ו-00:00-06:00), ובגלל כלל ה-08:00 שניהם הוצגו באותו יום (היום הראשון) - המערכת מנסה **לאחד אותם** חזרה לשורה אחת, בתנאי שהם מאותו סוג ותעריף.

### 3.4. סינון ימים ריקים
*   ימים שבהם סך שעות העבודה נמוך מ-1 דקה (ולא כוללים כוננות) מסוננים ואינם מוצגים בסיכום החודשי המרוכז.

---

## 4. סיכומים

### 4.1. סיכום יומי
*   מוצג בתחתית כל יום בדוח הרצפים ובטבלה המרוכזת.
*   כולל: סה"כ שעות עבודה (ללא כוננות), סה"כ לתשלום, ופירוט שעות לפי תעריפים (100-200%).

### 4.2. סיכום חודשי
*   **סה"כ שעות עבודה:** סיכום כל שעות העבודה נטו.
*   **סה"כ כוננויות:** ספירה של מספר המשמרות שכללו רכיב כוננות (נספר פעם אחת למשמרת, גם אם חצתה ימים).
*   **סה"כ לתשלום:** סכום כל התשלומים עבור שעות העבודה (לא כולל תשלום גלובלי על כוננות אם קיים בנפרד).
*   **חלוקה לאחוזים:** סיכום מצטבר של שעות בכל מדרגת תעריף.

